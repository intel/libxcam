/*
 * function: kernel_hdr_lab
 *     sample code of default kernel arguments
 * input:    image2d_t as read only
 * output:   image2d_t as write only
 */
__constant float table[] = {4.3287616f, 5.9319224f, 7.1324205f, 8.1288157f, 8.9965763f, 9.7739191f, 10.483327f, 11.139331f, 11.751958f, 12.328467f, 12.874310f, 13.393700f, 13.889977f, 14.365837f, 14.823494f, 15.264792f, 15.691289f, 16.104307f, 16.504990f, 16.894327f, 17.273184f, 17.642323f, 18.002419f, 18.354071f, 18.697817f, 19.034143f, 19.363485f, 19.686239f,
                            20.002764f, 20.313389f, 20.618416f, 20.918123f, 21.212763f, 21.502573f, 21.787767f, 22.068552f, 22.345116f, 22.617630f, 22.886259f, 23.151157f, 23.412468f, 23.670324f, 23.924854f, 24.176174f, 24.424398f, 24.669630f, 24.911972f, 25.151518f, 25.388355f, 25.622572f, 25.854246f, 26.083458f, 26.310276f, 26.534771f, 26.757010f, 26.977057f,
                            27.194969f, 27.410807f, 27.624624f, 27.836473f, 28.046406f, 28.254467f, 28.254467f, 28.254467f, 28.254467f, 28.254467f, 28.254467f, 28.254467f, 28.254467f, 28.254467f, 28.377895f, 28.567524f, 28.755781f, 28.942692f, 29.128284f, 29.312582f, 29.495617f, 29.677410f, 29.857986f, 30.037369f, 30.215582f, 30.392645f, 30.568581f, 30.743410f,
                            30.917152f, 31.089828f, 31.261454f, 31.432049f, 31.601633f, 31.770222f, 31.937832f, 32.104481f, 32.270180f, 32.434952f, 32.598808f, 32.761761f, 32.923832f, 33.085026f, 33.245361f, 33.404850f, 33.563507f, 33.721340f, 33.878368f, 34.034599f, 34.190044f, 34.344715f, 34.498627f, 34.651783f, 34.804199f, 34.955887f, 35.106853f, 35.257107f,
                            35.406662f, 35.555523f, 35.703705f, 35.851208f, 35.998051f, 36.144238f, 36.289776f, 36.434673f, 36.578941f, 36.722588f, 36.865616f, 37.008038f, 37.008038f, 37.008038f, 37.008038f, 37.008038f, 37.008038f, 37.008038f, 37.008038f, 37.008038f, 37.008038f, 37.008038f, 37.008038f, 37.008038f, 37.013512f, 37.148350f, 37.282703f, 37.416573f,
                            37.549969f, 37.682888f, 37.815342f, 37.947330f, 38.078865f, 38.209946f, 38.340580f, 38.470768f, 38.600517f, 38.729836f, 38.858719f, 38.987175f, 39.115215f, 39.242832f, 39.370041f, 39.496838f, 39.623226f, 39.749214f, 39.874802f, 40.0f, 40.124805f, 40.249222f, 40.373260f, 40.496914f, 40.620193f, 40.743095f, 40.865631f, 40.987804f,
                            41.109608f, 41.231056f, 41.352146f, 41.472885f, 41.593269f, 41.713306f, 41.833000f, 41.952354f, 42.071369f, 42.190048f, 42.308392f, 42.426407f, 42.544094f, 42.661457f, 42.778500f, 42.895222f, 43.011627f, 43.127716f, 43.243496f, 43.243496f, 43.243496f, 43.243496f, 43.243496f, 43.243496f, 43.243496f, 43.243496f, 43.243496f, 43.243496f,
                            43.243496f, 43.243496f, 43.243496f, 43.243496f, 43.243496f, 43.243496f, 43.243496f, 43.315910f, 43.427536f, 43.538902f, 43.650013f, 43.760872f, 43.871479f, 43.981831f, 44.091938f, 44.201797f, 44.311413f, 44.420780f, 44.529911f, 44.638798f, 44.747448f, 44.855862f, 44.964039f, 45.071983f, 45.179695f, 45.287178f, 45.394428f, 45.501453f,
                            45.608253f, 45.714825f, 45.821178f, 45.927307f, 46.033215f, 46.138905f, 46.244377f, 46.349632f, 46.454674f, 46.559505f, 46.664120f, 46.768528f, 46.872723f, 46.976711f, 47.080494f, 47.184067f, 47.287441f, 47.390610f, 47.493576f, 47.596344f, 47.698910f, 47.801281f, 47.903454f, 48.005428f, 48.107212f, 48.107212f, 48.107212f, 48.107212f,
                            48.107212f, 48.107212f, 48.107212f, 48.107212f, 48.107212f, 48.107212f, 48.107212f, 48.107212f, 48.107212f, 48.107212f, 48.107212f, 48.107212f, 48.107212f, 48.107212f, 48.107212f, 48.116840f, 48.216503f, 48.316002f, 48.415333f, 48.514507f, 48.613514f, 48.712364f, 48.811050f, 48.909580f, 49.007950f, 49.106163f, 49.204220f, 49.302116f,
                            49.399860f, 49.497452f, 49.594887f, 49.692173f, 49.789303f, 49.886284f, 49.983109f, 50.079788f, 50.176319f, 50.272701f, 50.368935f, 50.465023f, 50.560966f, 50.656761f, 50.752411f, 50.847919f, 50.943279f, 51.038502f, 51.133583f, 51.228519f, 51.323318f, 51.417973f, 51.512493f, 51.606873f, 51.701115f, 51.795219f, 51.889191f, 51.983021f,
                            52.076717f, 52.170280f, 52.263706f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.357002f, 52.370274f, 52.462727f, 52.555069f, 52.647293f,
                            52.739407f, 52.831406f, 52.923294f, 53.015072f, 53.106739f, 53.198296f, 53.289738f, 53.381077f, 53.472301f, 53.563419f, 53.654430f, 53.745327f, 53.836124f, 53.926811f, 54.017391f, 54.107864f, 54.198231f, 54.288494f, 54.378651f, 54.468708f, 54.558655f, 54.648502f, 54.738243f, 54.827885f, 54.917419f, 55.006851f, 55.096188f, 55.185417f,
                            55.274551f, 55.363579f, 55.452511f, 55.541340f, 55.630070f, 55.718704f, 55.807240f, 55.895676f, 55.984013f, 56.072254f, 56.072254f, 56.072254f, 56.072254f, 56.072254f, 56.072254f, 56.072254f, 56.072254f, 56.072254f, 56.072254f, 56.072254f, 56.072254f, 56.072254f, 56.072254f, 56.072254f, 56.072254f, 56.072254f, 56.072254f, 56.072254f,
                            56.072254f, 56.072254f, 56.072254f, 56.072254f, 56.136337f, 56.224670f, 56.312920f, 56.401089f, 56.489174f, 56.577179f, 56.665100f, 56.752941f, 56.840698f, 56.928371f, 57.015968f, 57.103481f, 57.190918f, 57.278271f, 57.365547f, 57.452744f, 57.539856f, 57.626896f, 57.713852f, 57.800732f, 57.887531f, 57.974255f, 58.060902f, 58.147465f,
                            58.233959f, 58.320370f, 58.406708f, 58.492970f, 58.579155f, 58.665260f, 58.751289f, 58.837250f, 58.923130f, 59.008938f, 59.094666f, 59.180325f, 59.265907f, 59.351414f, 59.436852f, 59.522209f, 59.607498f, 59.607498f, 59.607498f, 59.607498f, 59.607498f, 59.607498f, 59.607498f, 59.607498f, 59.607498f, 59.607498f, 59.607498f, 59.607498f,
                            59.607498f, 59.607498f, 59.607498f, 59.607498f, 59.607498f, 59.607498f, 59.607498f, 59.607498f, 59.607498f, 59.607498f, 59.607498f, 59.607498f, 59.676125f, 59.762394f, 59.848598f, 59.934742f, 60.020828f, 60.106846f, 60.192806f, 60.278702f, 60.364540f, 60.450314f, 60.536030f, 60.621685f, 60.707275f, 60.792812f, 60.878284f, 60.963699f,
                            61.049049f, 61.134342f, 61.219578f, 61.304752f, 61.389870f, 61.474926f, 61.559925f, 61.644867f, 61.729748f, 61.814568f, 61.899334f, 61.984039f, 62.068687f, 62.153282f, 62.237812f, 62.322292f, 62.406708f, 62.491070f, 62.575375f, 62.659622f, 62.743816f, 62.827950f, 62.912029f, 62.912029f, 62.912029f, 62.912029f, 62.912029f, 62.912029f,
                            62.912029f, 62.912029f, 62.912029f, 62.912029f, 62.912029f, 62.912029f, 62.912029f, 62.912029f, 62.912029f, 62.912029f, 62.912029f, 62.912029f, 62.912029f, 62.912029f, 62.912029f, 62.912029f, 62.912029f, 62.912029f, 62.940441f, 63.026379f, 63.112267f, 63.198112f, 63.283909f, 63.369659f, 63.455360f, 63.541019f, 63.626637f, 63.712200f,
                            63.797718f, 63.883190f, 63.968624f, 64.054001f, 64.139343f, 64.224632f, 64.309875f, 64.395081f, 64.480240f, 64.565346f, 64.650414f, 64.735435f, 64.820412f, 64.905342f, 64.990234f, 65.075073f, 65.159874f, 65.244629f, 65.329346f, 65.414009f, 65.498634f, 65.583214f, 65.667747f, 65.752243f, 65.836693f, 65.921097f, 66.005463f, 66.089783f,
                            66.174057f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.258286f, 66.291786f, 66.378784f, 66.465752f,
                            66.552689f, 66.639587f, 66.726456f, 66.813293f, 66.900085f, 66.986855f, 67.073586f, 67.160286f, 67.246948f, 67.333572f, 67.420174f, 67.506737f, 67.593269f, 67.679764f, 67.766228f, 67.852654f, 67.939056f, 68.025421f, 68.111755f, 68.198051f, 68.284325f, 68.370560f, 68.456757f, 68.542923f, 68.629059f, 68.715164f, 68.801239f, 68.887276f,
                            68.973282f, 69.059258f, 69.145203f, 69.231110f, 69.316986f, 69.402832f, 69.488655f, 69.574432f, 69.574432f, 69.574432f, 69.574432f, 69.574432f, 69.574432f, 69.574432f, 69.574432f, 69.574432f, 69.574432f, 69.574432f, 69.574432f, 69.574432f, 69.574432f, 69.574432f, 69.574432f, 69.574432f, 69.574432f, 69.574432f, 69.574432f, 69.574432f,
                            69.574432f, 69.574432f, 69.574432f, 69.659309f, 69.748878f, 69.838425f, 69.927956f, 70.017456f, 70.106934f, 70.196388f, 70.285820f, 70.375237f, 70.464622f, 70.553986f, 70.643333f, 70.732658f, 70.821953f, 70.911224f, 71.000481f, 71.089706f, 71.178917f, 71.268105f, 71.357262f, 71.446404f, 71.535530f, 71.624619f, 71.713692f, 71.802750f,
                            71.891777f, 71.980789f, 72.069771f, 72.158737f, 72.247673f, 72.336594f, 72.425499f, 72.514374f, 72.603226f, 72.692062f, 72.780876f, 72.869659f, 72.958427f, 73.047173f, 73.135902f, 73.135902f, 73.135902f, 73.135902f, 73.135902f, 73.135902f, 73.135902f, 73.135902f, 73.135902f, 73.135902f, 73.135902f, 73.135902f, 73.135902f, 73.135902f,
                            73.135902f, 73.135902f, 73.135902f, 73.135902f, 73.135902f, 73.135902f, 73.135902f, 73.135902f, 73.151604f, 73.245392f, 73.339172f, 73.432938f, 73.526695f, 73.620430f, 73.714165f, 73.807884f, 73.901588f, 73.995285f, 74.088966f, 74.182640f, 74.276299f, 74.369942f, 74.463577f, 74.557198f, 74.650818f, 74.744415f, 74.838005f, 74.931580f,
                            75.025139f, 75.118698f, 75.212242f, 75.305771f, 75.399284f, 75.492798f, 75.586296f, 75.679771f, 75.773247f, 75.866707f, 75.960159f, 76.053596f, 76.147018f, 76.240433f, 76.333839f, 76.427231f, 76.520615f, 76.613983f, 76.707336f, 76.800690f, 76.894020f, 76.894020f, 76.894020f, 76.894020f, 76.894020f, 76.894020f, 76.894020f, 76.894020f,
                            76.894020f, 76.894020f, 76.894020f, 76.894020f, 76.894020f, 76.894020f, 76.894020f, 76.894020f, 76.894020f, 76.894020f, 76.894020f, 76.894020f, 76.900002f, 77.0f, 77.100006f, 77.200005f, 77.300003f, 77.400002f, 77.500000f, 77.600006f, 77.700005f, 77.800003f, 77.900002f, 78.0f, 78.099998f, 78.199997f, 78.300003f, 78.400002f, 78.500000f,
                            78.599998f, 78.699997f, 78.799995f, 78.899994f, 79.0f, 79.099998f, 79.199997f, 79.299995f, 79.400002f, 79.500000f, 79.599998f, 79.699997f, 79.799995f, 79.900002f, 80.0f, 80.099998f, 80.199997f, 80.299995f, 80.400002f, 80.500000f, 80.599998f, 80.699997f, 80.800003f, 80.900002f, 81.0f, 81.099998f, 81.199997f, 81.199997f, 81.199997f, 81.199997f,
                            81.199997f, 81.199997f, 81.199997f, 81.199997f, 81.199997f, 81.199997f, 81.199997f, 81.199997f, 81.199997f, 81.199997f, 81.199997f, 81.199997f, 81.199997f, 81.199997f, 81.299294f, 81.408134f, 81.516991f, 81.625862f, 81.734749f, 81.843643f, 81.952560f, 82.061493f, 82.170433f, 82.279388f, 82.388359f, 82.497353f, 82.606354f, 82.715363f,
                            82.824394f, 82.933441f, 83.042496f, 83.151573f, 83.260658f, 83.369759f, 83.478874f, 83.588005f, 83.697151f, 83.806305f, 83.915474f, 84.024666f, 84.133865f, 84.243080f, 84.352310f, 84.461555f, 84.570816f, 84.680084f, 84.789368f, 84.898666f, 85.007988f, 85.117310f, 85.226654f, 85.336006f, 85.445374f, 85.554764f, 85.664162f, 85.773575f,
                            85.882996f, 85.992439f, 86.101898f, 86.211365f, 86.320839f, 86.430336f, 86.539848f, 86.649376f, 86.758911f, 86.868454f, 86.978027f, 87.087608f, 87.197197f, 87.306801f, 87.416420f, 87.526054f, 87.635704f, 87.745361f, 87.855034f, 87.964722f, 88.074432f, 88.184143f, 88.293877f, 88.403618f, 88.513374f, 88.623146f, 88.732933f, 88.842728f,
                            88.952538f, 89.062363f, 89.172203f, 89.282051f, 89.391914f, 89.501793f, 89.611694f, 89.721596f, 89.831512f, 89.941444f, 90.051399f, 90.161354f, 90.271324f, 90.381310f, 90.491310f, 90.601326f, 90.711349f, 90.821388f, 90.931442f, 91.041512f, 91.151596f, 91.261681f, 91.371788f, 91.481911f, 91.592049f, 91.702187f, 91.812347f, 91.922516f,
                            92.032707f, 92.142906f, 92.253120f, 92.363342f, 92.473579f, 92.583839f, 92.694099f, 92.804375f, 92.914665f, 93.024971f, 93.135292f, 93.245621f, 93.355965f, 93.466316f, 93.576683f, 93.687073f, 93.797470f, 93.907875f, 94.018295f, 94.128731f, 94.239182f, 94.349640f, 94.460106f, 94.570595f, 94.681099f, 94.791611f, 94.902130f, 95.012665f,
                            95.123215f, 95.233788f, 95.344360f, 95.454948f, 95.565552f, 95.676170f, 95.786797f, 95.897430f, 96.008087f, 96.118752f, 96.229431f, 96.340126f, 96.450829f, 96.561539f, 96.672272f, 96.783012f, 96.893768f, 97.004532f, 97.115311f, 97.226112f, 97.336914f, 97.447731f, 97.558563f, 97.669403f, 97.780266f, 97.891129f, 98.002007f, 98.112900f,
                            98.223816f, 98.334732f, 98.445656f, 98.556602f, 98.667557f, 98.778526f, 98.889511f, 99.000504f, 99.111504f, 99.222519f, 99.333557f, 99.444603f, 99.555656f, 99.666718f, 99.777809f, 99.888893f, 100.0f
                           };

static float fun(float in)
{
    return in > 0.008856f ? (native_powr(in, 1.0f / 3)) : (7.787f * in + 16.0f / 116);
}
__kernel void kernel_hdr_lab (__read_only image2d_t input, __write_only image2d_t output)
{
    int x = get_global_id (0);
    int y = get_global_id (1);
    sampler_t sampler = CLK_NORMALIZED_COORDS_FALSE | CLK_ADDRESS_NONE | CLK_FILTER_NEAREST;
    float4 pixel_in, pixel_out;
    unsigned int table_id;
    pixel_in = read_imagef(input, sampler, (int2)(x, y));

    float X, Y, Z, L, a, b;
    X = 0.412453f * pixel_in.x + 0.357580f * pixel_in.y + 0.180423f * pixel_in.z;
    Y = 0.212671f * pixel_in.x + 0.715160f * pixel_in.y + 0.072169f * pixel_in.z;
    Z = 0.019334f * pixel_in.x + 0.119193f * pixel_in.y + 0.950227f * pixel_in.z;
    L = Y > 0.008856f ? (116.0f * native_powr(Y, 1.0f / 3) - 16.0f) : 903.3f * Y;
    a = 500 * (fun(X) - fun(Y));
    b = 200 * (fun(Y) - fun(Z));
    table_id = (unsigned int)(L * 10) < 1000 ? (unsigned int)(L * 10) : 999;
    L = table[table_id];
    float fX, fY, fZ;
    Y = (L / 116.0f) * (L / 116.0f) * (L / 116.0f);
    Y = Y < 0.008856f ? L / 903.3f : Y;
    fY = Y > 0.008856f ? (native_powr(Y, 1.0f / 3.0f)) : (7.787f * Y + 16.0f / 116.0f);
    fX = a / 500.0f + fY;
    X = fX * fX * fX;
    X = X < 0.008865f ? ((fX - 16.0f / 116.0f) / 7.787f) : X;
    fZ = fY - b / 200.0f;
    Z = fZ * fZ * fZ;
    Z = Z < 0.008865f ? ((fZ - 16.0f / 116.0f) / 7.787f) : Z;

    pixel_out.x = 3.240479f * X - 1.537150f * Y - 0.498535f * Z;
    pixel_out.y = -0.969256f * X + 1.875992f * Y + 0.041556f * Z;
    pixel_out.z = 0.055648f * X - 0.204043f * Y + 1.204043f * Z;
    pixel_out.w = pixel_in.w;
    write_imagef(output, (int2)(x, y), pixel_out);
}

